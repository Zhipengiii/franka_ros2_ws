#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import rclpy
from rclpy.node import Node
from dualarm_motion_planning.srv import GiveGoal
import sys
import time

# 定义任务类型枚举 
FREE = 1 # 无干涉
COLLISION_NO_BLOCKING = 2 # 有干涉无阻塞
BLOCKING = 3 # 阻塞

class DualArmTaskPublisher(Node):
    def __init__(self):
        super().__init__('dual_arm_task_pub')

        # 1. 创建服务客户端
        self.service_name = '/give_goal_1_2'
        self.client_ = self.create_client(GiveGoal, self.service_name)

        # 2. 等待服务上线
        self.get_logger().info(f'正在等待协调节点服务 ({self.service_name})...')
        while not self.client_.wait_for_service(timeout_sec=1.0):
            self.get_logger().info('服务未就绪，继续等待...')
        
        self.get_logger().info('协调节点服务已连接，准备开始实验。')

    def send_dual_task(self, exp_id, task_type, q_r1, q_r2, v=0.5, a=2.5):
        """
        通过统一服务话题依次给双臂发送目标任务
        """
        self.get_logger().info(f"--- 正在发送实验 [{exp_id}] (类型: {task_type}) ---")

        # 1. 构造左臂 (R1) 请求
        req_r1 = GiveGoal.Request()
        req_r1.robotid = 1
        req_r1.qgoal = q_r1
        req_r1.v_max = v
        req_r1.a_max = a
        req_r1.experiment_id = str(exp_id)
        req_r1.task_type = task_type

        # 2. 构造右臂 (R2) 请求
        req_r2 = GiveGoal.Request()
        req_r2.robotid = 2
        req_r2.qgoal = q_r2
        req_r2.v_max = v
        req_r2.a_max = a
        req_r2.experiment_id = str(exp_id)
        req_r2.task_type = task_type

        # 3. 异步调用服务
        self.get_logger().info(f"发送 R1 目标...")
        future_r1 = self.client_.call_async(req_r1)
        rclpy.spin_until_future_complete(self, future_r1)

        self.get_logger().info(f"发送 R2 目标...")
        future_r2 = self.client_.call_async(req_r2)
        rclpy.spin_until_future_complete(self, future_r2)

        # 检查回执
        if future_r1.result() is not None and future_r2.result() is not None:
            if future_r1.result().received and future_r2.result().received:
                self.get_logger().info(f"实验 [{exp_id}] 下发成功，协调节点已就绪。")
                return True
        
        self.get_logger().error(f"实验 [{exp_id}] 下发失败，请检查协调节点状态。")
        return False

def main(args=None):
    rclpy.init(args=args)
    node = DualArmTaskPublisher()

    # =========================================================================
    # 数据录入区域：在此处定义的实验数据
    # =========================================================================
    
    # 示例数据结构：[ (类型, R1关节角, R2关节角), ... ]
    
    # 1. Free Group (无干涉 1-10)
    # tasks_free = [
    #     # Case 1
    #     (FREE, 
    #      [0.338149120939511,0.221033483484982,1.11721935597819,-1.71411646572071,2.81767568979157,2.84872097298062,-0.750589930113507],  # R1 Goal
    #      [-0.708187247592792,0.193866496411561,-0.774975086327466,-1.5516230139884,-2.54830754784488,2.9579321010099,1.11664233826901]), # R2 Goal 
    #     # Case 2 
    #     (FREE, 
    #      [2.71928620021207,0.708239146900675,-1.3296850902088,-1.49360439413737,2.77678952480008,2.9296296111625,0.175762971589251,], 
    #      [-2.87105909611051,0.600926718633396,1.41558613562007,-1.50781950245833,-2.81273972295589,3.00755678130092,1.25959634689323,]),
    #     # Case 3
    #     (FREE,
    #      [-0.10051553464631,-1.15650858610924,1.62840288764457,-1.37734488768404,2.87622997201076,3.24676795115465,1.18364823171226],
    #      [-2.83820011245765,1.02585486246171,1.37126271867444,-1.00480557331624,-2.8762326749071,3.43378767922204,0.479277356901238,]),
    #     # Case 4
    #     (FREE,
    #      [-0.000594964476430734,-1.29237917686046,2.01514070467243,-1.58100640820653,2.82680053921007,3.2263515038439,1.69355035018885,],
    #      [0.512574264114717,-1.16410651634981,-2.5964355376164,-1.38808934979503,-0.896178503208254,3.94730873228521,-1.29133551272065,]),
    #     # Case 5
    #     (FREE,
    #      [0.0685166266820106,-1.36334815676696,1.88693438455792,-2.05117514652479,2.87623723346852,2.77367329109661,1.70652540341717,],
    #      [0.69852001727994,-1.41802698505314,-2.06551525068493,-2.16408861013859,-0.239960694141441,4.60427089132721,-2.48593711065832,]),
    #     # Case 6
    #     (FREE,
    #      [-0.311999372110413,-1.2803196989883,2.0798009924691,-2.32971876402072,2.75700193712705,2.27731649531465,1.4751943277599,],
    #      [0.655406536881628,-1.17563772271672,-2.42855965947425,-1.9181918697981,0.192018618588893,3.94367501889909,-2.67859693501348,]),
    #     # Case 7
    #     (FREE,
    #      [-0.0906116131628027,-0.905276561170065,1.04023414898884,-1.96437987815637,2.14269437110172,2.40088274271417,1.85813245853957,],
    #      [-0.335442258818482,-0.815305196893457,-1.4478770055293,-2.10178393160289,-0.0985041309305494,3.44399728306404,-2.36734248285692,]),
    #     # Case 8
    #     (FREE,
    #      [0.347135506825155,-0.47562675834594,1.4027342837499,-1.68577380983263,2.03210263961033,3.28939923185567,3.05075098764219,],
    #      [-0.264142783675645,-0.704502758380778,-1.6927112590723,-1.58478844959858,0.882246695744312,3.64548791776703,-1.43521820126721,]),
    #     # Case 9
    #     (FREE,
    #      [-0.782077435520977,-0.61576282644926,1.28084911835603,-1.30778723823412,2.83120019083144,3.25050479699657,2.75361394407528,],
    #      [-0.28069883578963,-0.242551606636084,-0.857676794129905,-1.97355589244763,0.737552861611314,3.87933448859401,-0.957219278611474,]),
    #     # Case 10
    #     (FREE,
    #      [-0.70067010605767 ,-1.35523017894689 ,2.62770143903969 ,-1.38517768364507 ,2.60780225683365 ,2.81014817104555 ,2.37203838851095 ,], 
    #      [1.10840227219175 ,-1.77764159119635 ,-2.5453287574303 ,-1.27026392063505 ,0.382461831891528 ,3.43622053211296 ,-1.61723242088934 ,]),
    # ]

    # 2. Collision Group (有干涉无阻塞 11-20)
    tasks_collision = [
        # # Case 11
        # (COLLISION_NO_BLOCKING,
        #  [-1.21059534803441 ,-1.39865580952402 ,2.33255542655685 ,-1.82449545238996 ,2.72327665613782 ,2.13286709053037 ,1.97921567583427 ,], 
        #  [0.127080062634418 ,-0.482493634775389 ,-1.92199475289556 ,-2.54932004661815 ,0.48669226403988 ,2.82200245671622 ,-1.4022484965634 ,]),
        # # Case 12
        # (COLLISION_NO_BLOCKING,
        #  [-0.47784830384826 ,-1.3728946360119 ,2.74864301686738 ,-1.28905441834896 ,2.85116637843498 ,3.33273455273617 ,3.02478288574601 ,],
        #  [0.895420644654072 ,-1.69246260625706 ,-2.53436730449775 ,-1.39577386439111 ,0.724571668657076 ,3.2315115074306 ,-0.998768015007757 ,]),
        # # Case 13
        # (COLLISION_NO_BLOCKING,
        # [-0.947613006432937 ,-1.22620840022521 ,2.47629021683008 ,-2.24515657246248 ,2.40267680376242 ,2.3302312336095 ,2.81532798679817 ,],
        # [0.184492518267736 ,-0.367085009043641 ,-2.25056944119226 ,-2.50904562311582 ,0.905963461842299 ,2.85610207370365 ,-0.906262016570413 ,]),
        # # Case 14
        # (COLLISION_NO_BLOCKING,
        # [-0.495743992598606 ,-1.40006127456293 ,2.55366351491385 ,-1.38234061773479 ,1.49137546901902 ,1.79991087056157 ,2.62681637647783 ,],
        # [0.522339773105188 ,-1.40517645931041 ,-2.56723547832593 ,-1.83210136078161 ,1.32951444775599 ,3.06399564328062 ,0.0819738247922056 ,]),
        # # Case 15
        # (COLLISION_NO_BLOCKING,
        # [-0.953462108228524 ,-1.37525208074823 ,2.42768630436653 ,-1.96500253976418 ,1.40143836913037 ,1.72503723997882 ,1.88982288695536 ,],
        # [0.359255145191355 ,-0.236752193318088 ,-2.71937504881824 ,-2.38068496381853 ,0.871113174437016 ,2.39024569734567 ,0.817360714499104 ,]),
        # # Case 16
        # (COLLISION_NO_BLOCKING,
        # [-0.495743992598606 ,-1.40006127456293 ,2.55366351491385 ,-1.38234061773479 ,1.49137546901902 ,1.79991087056157 ,2.62681637647783 ,],
        # [0.522339773105188 ,-1.40517645931041 ,-2.56723547832593 ,-1.83210136078161 ,1.32951444775599 ,3.06399564328062 ,0.0819738247922056 ,]),
        # # Case 17
        # (COLLISION_NO_BLOCKING,
        # [-0.999523949603229,-1.23218002902806,2.5896895449252,-2.23100948175726,1.30455532252166,1.70881325191724,1.74521917239072,],
        # [0.473299384229599,-0.184077730899116,-2.77977865725452,-2.32128755340298,0.856840572798073,2.33121000653119,0.930300057990468,]),
        # # Case 18
        # (COLLISION_NO_BLOCKING,
        # [-0.539339192260156 ,-1.37396543009409 ,2.44769431053033 ,-1.25857685261752 ,1.11775921171629 ,1.84631648908292 ,2.25622728622234 ,],
        # [0.674137884531784 ,-1.27149170668557 ,-2.62037883473661 ,-1.79427658196143 ,0.973031177715333 ,2.85772950376734 ,1.03352059678109 ,]),
        # # Case 19
        # (COLLISION_NO_BLOCKING,
        # [-0.896138619304105,-1.31627097824568,2.3698449746909,-1.86576131346835,1.12835669810286,2.05449700996215,1.41264273021384,],
        # [0.534945435117833,-0.447148880771977,-2.68879869384913,-2.14515921589429,0.891637577824834,2.53462109973419,1.36956241181843,]),
        # Case 20
        (COLLISION_NO_BLOCKING,
        [-0.521493121557289,-1.4646425590265,2.53277027278135,-1.21178696866862,1.1432559462719,1.9483476672956,2.28935286918022,],
        [0.624866512382443,-1.39170111606772,-2.5625053065409,-1.69130628830345,1.03796650612935,3.02129146948073,0.888303211696853,]),
    ]

    # 3. Blocking Group (阻塞 21-30)
    # 这里填入你之前脚本中的那些复杂点位
    tasks_blocking = [
        # Case 21
        (BLOCKING,
         [-1.10149375999966,-1.69826895629369,2.43453134275701,-1.46215690552103,1.23630567868708,2.09846212665702,1.41194186344233,],
         [0.577547555479082,-1.30332099741906,-2.82824967832485,-1.40836682375394,0.660484950133433,2.56379838709354,2.08027151651413,]),
    ]

    # 合并所有任务列表
    all_experiments = []
    # 添加时自动分配 ID
    current_id = 1
    
    # for task in tasks_free:
    #     all_experiments.append({'id': f"Exp_{current_id:02d}", 'type': task[0], 'r1': task[1], 'r2': task[2]})
    #     current_id += 1
        
    for task in tasks_collision:
        all_experiments.append({'id': f"Exp_{current_id:02d}", 'type': task[0], 'r1': task[1], 'r2': task[2]})
        current_id += 1

    for task in tasks_blocking:
        all_experiments.append({'id': f"Exp_{current_id:02d}", 'type': task[0], 'r1': task[1], 'r2': task[2]})
        current_id += 1

    # =========================================================================
    # 手动控制循环
    # =========================================================================
    print("\n" + "="*50)
    print("双臂协调实验手动控制台启动")
    print(f"共加载任务数: {len(all_experiments)}")
    print("请按 [Enter] 键发送下一组任务，按 [Ctrl+C] 退出")
    print("="*50 + "\n")

    try:
        for task in all_experiments:
            exp_id = task['id']
            type_str = "未知"
            if task['type'] == FREE: type_str = "Free"
            elif task['type'] == COLLISION_NO_BLOCKING: type_str = "Collision"
            elif task['type'] == BLOCKING: type_str = "Blocking"

            # 1. 阻塞等待用户输入
            input(f">>> 准备就绪: 实验 [{exp_id}] - 类型 [{type_str}]。按回车发送...")

            # 2. 发送任务
            node.send_dual_task(
                exp_id=exp_id,
                task_type=task['type'],
                q_r1=task['r1'],
                q_r2=task['r2'],
                v=1.0,
                a=5.0
            )

            print(f"    实验 [{exp_id}] 已下发，请观察仿真/实物运行情况。\n")
            
        print("所有预设实验已执行完毕。")

    except KeyboardInterrupt:
        print("\n实验中断，正在退出...")
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()